<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin - SpeedyDelivery</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
  h1 { text-align: center; color: #ff6600; }
  .form-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto 30px auto; }
  input, button { width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
  button { background: #ff6600; color: white; font-weight: bold; border: none; cursor: pointer; }
  .tracking-history { max-width: 700px; margin: 0 auto; }
  .tracking-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .status { font-weight: normal; padding: 5px 0; }
  .latest { background: #fffae6; border-left: 5px solid #ff6600; padding-left: 10px; }
  .time { color: gray; font-size: 0.9em; }
  .location { color: #0077cc; font-size: 0.9em; }
  .delete-btn, .edit-btn { border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; margin-left:5px;}
  .delete-btn { background: red; color: white; }
  .edit-btn { background: #0077cc; color: white; }
  .clear-btn { display: block; margin: 20px auto; background: #444; }
  .change-pass-btn { background: #555; color: white; margin-top: 10px; }
</style>
</head>
<body>

<h1>Admin Panel</h1>

<div class="form-container">
  <input type="text" id="trackingId" placeholder="Tracking ID (leave empty to auto-generate)" />
  <input type="text" id="status" placeholder="Status update..." required />
  <input type="text" id="location" placeholder="Last known location (optional)" />
  <input type="datetime-local" id="time" />
  <button onclick="addTrackingUpdate()">Add/Save Update</button>
  <button class="change-pass-btn" onclick="changePassword()">Change Password</button>
</div>

<div class="tracking-history" id="trackingHistory"></div>
<button class="clear-btn" onclick="clearAll()">Clear All Data</button>

<script>
let password = localStorage.getItem("adminPassword");
if(!password){
  password = prompt("Create Admin Password:");
  localStorage.setItem("adminPassword", password);
}
else{
  let input = prompt("Enter Admin Password:");
  if(input !== password) {
    alert("Wrong password! Access denied.");
    document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Access Denied</h1>";
    throw new Error("Wrong password");
  }
}

function changePassword(){
  let current = prompt("Enter current password:");
  if(current !== localStorage.getItem("adminPassword")){
    alert("Wrong current password!");
    return;
  }
  let newPass = prompt("Enter new password:");
  if(newPass) localStorage.setItem("adminPassword", newPass);
  alert("Password changed successfully!");
}

let trackingData = JSON.parse(localStorage.getItem("trackingData")) || {};
let editing = null;

function saveData(){
  localStorage.setItem("trackingData", JSON.stringify(trackingData));
  renderHistory();
}

function generateTrackingID(){
  return 'SP'+Math.floor(100000000 + Math.random()*900000000);
}

function addTrackingUpdate(){
  let id = document.getElementById("trackingId").value.trim();
  const status = document.getElementById("status").value.trim();
  const location = document.getElementById("location").value.trim();
  const time = document.getElementById("time").value || "";

  if(!id) id = generateTrackingID();

  if(!trackingData[id]){
    // New tracking ID â†’ first status
    trackingData[id] = [{status:"Label Created, not yet in system", location:""}];
  }

  if(editing){
    const {editId, editIndex} = editing;
    trackingData[editId][editIndex] = {status, location, time};
    editing = null;
  } else {
    trackingData[id].unshift({status, location, time});
    // Add 6 default USPS-style statuses if first admin update
    if(trackingData[id].length === 2){ // first + this new
      const defaultStatuses = [
        {status:"Shipment Accepted", location:""},
        {status:"Arrived at Regional Facility", location:""},
        {status:"In Transit", location:""},
        {status:"Out for Delivery", location:""},
        {status:"Arrived at Destination Facility", location:""},
        {status:"Delivered", location:""}
      ];
      trackingData[id].push(...defaultStatuses);
    }
  }

  saveData();

  document.getElementById("trackingId").value = "";
  document.getElementById("status").value = "";
  document.getElementById("location").value = "";
  document.getElementById("time").value = "";
}

function editUpdate(id,index){
  const update = trackingData[id][index];
  document.getElementById("trackingId").value = id;
  document.getElementById("status").value = update.status;
  document.getElementById("location").value = update.location;
  document.getElementById("time").value = update.time.slice(0,16);
  editing = {editId:id, editIndex:index};
}

function deleteUpdate(id,index){
  trackingData[id].splice(index,1);
  if(trackingData[id].length === 0) delete trackingData[id];
  saveData();
}

function clearAll(){
  if(confirm("Are you sure you want to clear ALL data?")){
    trackingData = {};
    saveData();
  }
}

function renderHistory(){
  const container = document.getElementById("trackingHistory");
  container.innerHTML = "";
  Object.keys(trackingData).forEach(id=>{
    const card = document.createElement("div");
    card.className = "tracking-card";
    const header = document.createElement("h3");
    header.textContent = `Tracking ID: ${id}`;
    card.appendChild(header);

    trackingData[id].forEach((update,i)=>{
      const div = document.createElement("div");
      div.className = "status";
      // highlight latest
      if(i===0) div.classList.add("latest");
      div.innerHTML = `${update.status}${update.time?` <span class="time">(${new Date(update.time).toLocaleString()})</span>`:""}`;
      if(update.location) div.innerHTML += `<div class="location">ðŸ“Œ ${update.location}</div>`;

      const editBtn = document.createElement("button");
      editBtn.textContent = "Edit";
      editBtn.className = "edit-btn";
      editBtn.onclick = ()=>editUpdate(id,i);
      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.className = "delete-btn";
      delBtn.onclick = ()=>deleteUpdate(id,i);

      div.appendChild(editBtn);
      div.appendChild(delBtn);
      card.appendChild(div);
    });

    container.appendChild(card);
  });
}

renderHistory();
</script>

</body>
</html>